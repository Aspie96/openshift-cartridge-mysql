#!/bin/bash

source $OPENSHIFT_CARTRIDGE_SDK_BASH

${HOME}/bin/control stop

# Start server in "admin mode"
${OPENSHIFT_DATA_DIR}.mysql/bin/mysqld \
  --defaults-file=${OPENSHIFT_DATA_DIR}.mysql/my.cnf \
  --skip-grant-tables --skip-networking &
i=0
while [ -z "$(ps -ef | grep 'mysqld' | grep -v grep)" ] && [ $i -lt 60 ]; do
  sleep 1
  i=$(($i + 1))
done

# Change root password
echo "
UPDATE mysql.user SET host = '%' WHERE user = 'root';
FLUSH PRIVILEGES;
ALTER USER 'root'@'%' IDENTIFIED BY 'root';
" | ${OPENSHIFT_DATA_DIR}.mysql/bin/mysql --socket=${TMP}/mysql.sock

# Stop server
kill "$(ps -ef | grep 'mysqld' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1
i=0
while [ ! -z "$(ps -ef | grep 'mysqld' | grep -v grep)" ] && [ $i -lt 60 ]; do
  sleep 1
  i=$(($i + 1))
done

${HOME}/bin/control start

# Output result
client_result "The initial root password was set to 'root', make sure to change it."
